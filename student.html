<!DOCTYPE HTML>
<html>
	<!-- TODO : Check if OS version is recent enough. I know 5.0.1 does not work -->
<head>
        <link rel="stylesheet" href="lib/jqtouch.css" title="jQTouch">

        <!--<script src="../../src/lib/zepto.min.js" type="text/javascript" charset="utf-8"></script>-->
        <script src="lib/jqtouch.min.js" type="text/javascript" charset="utf-8"></script>
        <!-- Uncomment the following two lines (and comment out the previous two) to use jQuery instead of Zepto. -->
		<script src="lib/jquery-1.7.min.js" type="application/x-javascript" charset="utf-8"></script>
        <script src="lib/jqtouch-jquery.min.js" type="application/x-javascript" charset="utf-8"></script>

        <script type="text/javascript" charset="utf-8">
          
        </script>

	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
	<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
	<script type="text/javascript">
		var jQT = new $.jQTouch({});
		checkTeacherAvailability();
		var teacherConnected = false;
		$(function(){
			$('#raise_hand').tap(function(){
				raiseHand();
				//alert('hi');
			});
		});
		var webSocket;
		var webSocket2;
		var teacherPresent = false;
		function checkTeacherAvailability() {
			console.debug('checkTeacherAvailability() - begin');
			connect();
			webSocket2.onopen = function() {
				// This gets called even if the socket doesn't get opened successfully.
				console.debug('attempting to send after connect attempt');
				var msg = "LOAD::" + $('input[id=name]').val();
				webSocket2.send(msg);
				console.debug('sent after connect attempt');
				console.debug('checkTeacherAvailability.onopen() end');
			};
			webSocket2.onmessage = function (evt) { 
				// To clear participation
				var received_msg = evt.data;
				handleMessage(received_msg)
			};
			webSocket2.onclose = function() { 
				setButtonEnabled(false);
			};
			console.debug('checkTeacherAvailability() - end');
		}
		function handleMessage(received_msg) {
			if (received_msg == 'TEACHER_MISSING') {
				setButtonEnabled(false);
			} else if (received_msg == 'TEACHER_JOINED') {
				setButtonEnabled(true);
			} else if (received_msg == 'TEACHER_PRESENT') {
				setButtonEnabled(true);
			} else if (received_msg == 'TEACHER_LEFT') {
				setButtonEnabled(false);
			} else if (received_msg == 'CLEAR') {
				changeButton();
				setButtonEnabled(true);
			} else {
				alert(received_msg);
				setButtonEnabled(false);
			} 
			console.debug('checkTeacherAvailability.onmessage() end');
		}
		function setButtonEnabled(enabled) {
			teacherPresent = enabled;
			if (enabled) {
				$('#raise_hand').removeClass();
				$('#raise_hand').addClass('whiteButton');
				$('#raise_hand').html("Raise hand");
			} else {			
				$('#raise_hand').removeClass();
				$('#raise_hand').addClass('grayButton');
				$('#raise_hand').html("Professor not logged in");
			}
		}
		function connect() {
			//webSocket = new WebSocket("ws://localhost:8081/");
			webSocket = new WebSocket("ws://netgear.rohidekar.com:8081/");
			webSocket2 = new WebSocket("ws://netgear.rohidekar.com:8081/");
		}
		// DEPRECATED
		function connectAndSend() {
			console.debug('connectAndSend() end');
			connect();
			console.debug('webSocket now initialized');
			webSocket.onopen = function() {
				// This gets called even if the socket doesn't get opened successfully.
				console.debug('attempting to send after connect attempt');
				changeButton();
				console.debug('sent after connect attempt');
				console.debug('onopen() end');
			};
			webSocket.onmessage = function (evt) { 
				// To clear participation
				var received_msg = evt.data;
				alert(received_msg);
				console.debug('onmessage() end');
			};
			webSocket.onclose = function() { 
				console.debug('onclose() end');
				alert('closed 1');
			};
			console.debug('connectAndSend() end');
		}
		
		function raiseHand() {
			console.debug('1');
			// Should not be dependent on teacher's page being open
			if (webSocket == null) {
				console.debug('2');
				connectAndSend();
			} else {
				console.debug('Socket previously initialized');
				changeButton();
				console.debug('Successfully sent message');
			}
			
		}
		function changeButton() {
			if ($('#raise_hand').html() == "Lower hand") {
				lowerHand();
			} else {
				raiseHandDo();
			}
		}
		function raiseHandDo() {
			if (!teacherPresent) {
				return;
			}
			var msg = "RAISE::" + $('input[id=name]').val();
			webSocket.send(msg);
			$('#raise_hand').removeClass();
			$('#raise_hand').addClass('greenButton');
			$('#raise_hand').html("Lower hand");
		}
		function lowerHand() {
			$('#raise_hand').removeClass();
			$('#raise_hand').addClass('whiteButton');
			$('#raise_hand').html("Raise hand");
			var msg = "LOWER::" + $('input[id=name]').val();
			webSocket.send(msg);
		}
	</script>
</head>
<body onload="">
	<div id="jqt">
		<div id="callbacks">
			<div class="toolbar">
				<h1>SPOT</h1>
	
		
			
		</div>
	
			<form>
				<ul class="edit rounded">
					<li><input id="name" type="text" value="Anonymous" onchange="connect()"/></li>
				</ul>
			</form>
				<ul class="rounded">
					<li><a href="#" class="grayButton" id="raise_hand">Professor not logged in</a></li>
				</ul>
		</div>
		
		<div id="buttons">
	
	
	</div>
</body>
</html>