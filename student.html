<!DOCTYPE HTML>
<html>
	<!-- TODO : Check if OS version is recent enough. I know 5.0.1 does not work -->
<head>
        <link rel="stylesheet" href="lib/jqtouch.css" title="jQTouch">

        <!--<script src="../../src/lib/zepto.min.js" type="text/javascript" charset="utf-8"></script>-->
        <script src="lib/jqtouch.min.js" type="text/javascript" charset="utf-8"></script>
        <!-- Uncomment the following two lines (and comment out the previous two) to use jQuery instead of Zepto. -->
		<script src="lib/jquery-1.7.min.js" type="application/x-javascript" charset="utf-8"></script>
        <script src="lib/jqtouch-jquery.min.js" type="application/x-javascript" charset="utf-8"></script>

        <script type="text/javascript" charset="utf-8">
          
        </script>

	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
	<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
	<script type="text/javascript">
		var jQT = new $.jQTouch({});
		checkTeacherAvailability();
		var teacherConnected = false;
		$(function(){
			$('#raise_hand').tap(function(){
				raiseHand();
				//alert('hi');
			});
		});
		var webSocket;
		function checkTeacherAvailability() {
			console.debug('checkTeacherAvailability() - begin');
			connect();
			webSocket.onopen = function() {
				// This gets called even if the socket doesn't get opened successfully.
				console.debug('attempting to send after connect attempt');
				var msg = "LOAD::" + $('input[id=name]').val();
				webSocket.send(msg);
				console.debug('sent after connect attempt');
				console.debug('checkTeacherAvailability.onopen() end');
			};
			webSocket.onmessage = function (evt) { 
				// To clear participation
				var received_msg = evt.data;
				//alert(received_msg);
				if (received_msg == 'TEACHER_MISSING') {
					teacherConnected = false;
					//$('#raise_hand').hide();
					//$('#raise_hand').toggleClass('grayButton');
				} else if (received_msg == 'TEACHER_JOINED') {
					//alert(received_msg);
					$('#raise_hand').removeClass('grayButton');
					$('#raise_hand').addClass('whiteButton');
				} else if (received_msg == 'TEACHER_LEFT') {
					//alert(received_msg);
					$('#raise_hand').removeClass('whiteButton');
					$('#raise_hand').addClass('grayButton');
				} else {
					teacherConnected = true;
				}
				console.debug('checkTeacherAvailability.onmessage() end');
			};
			webSocket.onclose = function() { 
				console.debug('onclose() end');
			};
			console.debug('checkTeacherAvailability() - end');
		}
		function connect() {
			//webSocket = new WebSocket("ws://localhost:8081/");
			webSocket = new WebSocket("ws://netgear.rohidekar.com:8081/");
		}
		// DEPRECATED
		function connectAndSend() {
			console.debug('connectAndSend() end');
			connect();
			console.debug('webSocket now initialized');
			webSocket.onopen = function() {
				// This gets called even if the socket doesn't get opened successfully.
				console.debug('attempting to send after connect attempt');
				var msg = "RAISE::" + $('input[id=name]').val();
				webSocket.send(msg);
				console.debug('sent after connect attempt');
				console.debug('onopen() end');
			};
			webSocket.onmessage = function (evt) { 
				// To clear participation
				var received_msg = evt.data;
				alert(received_msg);
				console.debug('onmessage() end');
			};
			webSocket.onclose = function() { 
				console.debug('onclose() end');
			};
			console.debug('connectAndSend() end');
		}
		
		function raiseHand() {
			console.debug('1');
			// Should not be dependent on teacher's page being open
			if (webSocket == null) {
				console.debug('2');
				connectAndSend();
			} else {
				console.debug('Socket previously initialized');
				console.debug('3');
				var msg = "RAISE::" + $('input[id=name]').val();
				console.debug('Attempting to communicate with server...');
				webSocket.send(msg);
				console.debug('Successfully sent message');
			}
			
		}
	</script>
</head>
<body onload="">
	<div id="jqt">
		<div id="callbacks">
			<div class="toolbar">
				<h1>SPOT</h1>
	
		
			
		</div>
	
			<form>
				<ul class="edit rounded">
					<li><input id="name" type="text" value="Anonymous" onchange="connect()"/></li>
				</ul>
			</form>
				<ul class="rounded">
					<li><a href="#" class="whiteButton" id="raise_hand">Raise hand</a></li>
				</ul>
		</div>
		
		<div id="buttons">
	
	
	</div>
</body>
</html>